using System.Collections.Generic;
using System;
using UtilitiesGenetic;

namespace Genetics
{
	public class GeneticController
	{
		private GeneticAlgorithm ga;
		private TypeParams[] typeParams;

		public void StartGenetics(Vector3Int size, TypeParams[] cellsInfos, int[][][] waypointParams, EvolutionaryAlgoParams algoParams,
			SharpNeatLib.Maths.FastRandom randomFast)
		{
			typeParams = new TypeParams[cellsInfos.Length + 1];
			SetTypeCellParams(cellsInfos);

			Mutations.InitMutations(size, randomFast, typeParams, algoParams.mutationType);

			ga = new GeneticAlgorithm(algoParams, size, waypointParams, typeParams, randomFast);
		}

		private void SetTypeCellParams(TypeParams[] cellsInfos)
		{
			typeParams[0] = new TypeParams();
			typeParams[0].SetEmpty();

			for (int i = 0; i < typeParams.Length - 1; i++)
			{
				typeParams[i + 1] = cellsInfos[i];
			}
		}


		public void UpdateGenetics()
		{
			ga.NewGeneration();
		}

		public int[][][] GetBestClusters()
        {
			ga.ClassifyPopulation();

			int nbNeighbors = 0;
			
			foreach (WalkableArea wa in ga.oldPopulation[0].phenotype.walkableArea)
			{
				nbNeighbors += wa.neighborsArea.Count; 
			}

			return ga.oldPopulation[0].Genes;
		}

		public float GetBestTotalFitness()
		{
			ga.ClassifyPopulation();

			return ga.oldPopulation[0].fitness.total;
		}

		public Fitness[][] GetFitness()
		{
			return ga.fitnessPopulation;
		}

		public Population[][] GetPopulations()
		{
			return ga.populations;
		}
	}
}
